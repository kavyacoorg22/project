<div class="hero-wrap hero-bread" style="background-image: url('/images/bg_1.jpg');">
  <div class="container">
    <div class="row no-gutters slider-text align-items-center justify-content-center">
      <div class="col-md-9 ftco-animate text-center">
        <p class="breadcrumbs">
          <span class="mr-2"><a href="/user/home">Home</a></span> 
          <% if(currentPage !== 'Home') { %>
              <span><%= currentPage %></span>
          <% } %>
      </p>
        <h1 class="mb-0 bread">Order Details</h1>
      </div>
    </div>
  </div>
</div>

<div class="layout-wrapper">
  <aside class="sidebar">
      <a href="/user/profile"><span>Profile</span></a>
      <a href="/user/address"><span>Address</span></a>
      <a href="#" class="active"><span>Order</span></a>
      <a href="/user/wallet"><span>Wallet</span></a>
      <a href="/user/logout" class="logout" onclick="logout(event)"><span>Logout</span></a>
  </aside>

  <div class="od-container">
      <div class="od-thank-you">
          <h1 class="od-thank-you-title">Thank You for Your Purchase!</h1>
          <p class="od-order-status">Your order is <%=orders.status%>. Order ID: <span class="od-order-id"><%=orders.orderID%></span></p>
      </div>
   
      <div class="od-grid">
          <div class="od-info-section">
              <h2 class="od-info-title">Order Details</h2>
              <div class="od-info-grid">
                  <span class="od-label">Customer:</span>
                  <span class="od-value"><%=orders.user.firstname%></span>
                  
                  <span class="od-label">Order Date:</span>
                  <span class="od-value"><%=orders.orderDate.toLocaleString()%></span>
                  
                  <span class="od-label">Phone:</span>
                  <span class="od-value"><%=orders.user.number%></span>
                  
                  <span class="od-label">Payment Method:</span>
                  <span class="od-value"><%=orders.paymentMethod%></span>
              </div>
          </div>

          <div class="od-info-section">
              <h2 class="od-info-title">Address Information</h2>
              <div class="od-info-grid">
                  <span class="od-label">Billing Address:</span>
                  <span class="od-value"><%=orders.billingDetails.firstName%><%=orders.billingDetails.lastName%>
                    <%=orders.billingDetails.address%><%=orders.billingDetails.postalCode%><%=orders.billingDetails.mobile%>
                    <%=orders.billingDetails.email%>
                  </span>
                  
                  <span class="od-label">Delivery Address:</span>
                  <span class="od-value"><%=orders.deliveryAddress.firstname%><%=orders.deliveryAddress.lastname%>
                    <%=orders.deliveryAddress.address%><%=orders.deliveryAddress.postalCode%><%=orders.deliveryAddress.mobile%>
                    <%=orders.deliveryAddress.email%></span>
              </div>
          </div>
      </div>

      <div class="od-items-section">
          <h2 class="od-items-title">Order Items</h2>
          <table class="od-table">
              <thead>
                  <tr>
                      <th>Image</th>
                      <th>Product</th>
                      <th>Status</th>
                      <th>Quantity</th>
                      <th>Price</th>
                      <th>Total</th>
                      <th>Action</th>
                  </tr>
              </thead>
              <tbody>
                <% orders.orderedItem.forEach(function(item) { %>
                  <tr onclick="window.location.href='/user/product/<%= item.product._id %>'" style="cursor: pointer;">
                    <td><img src="/img/productsimg/<%=item.firstImage%>" alt="<%=item.name%>" class="od-product-img"></td>
                    <td><%=item.name%></td>
                    <td><span class="od-status-<%=orders.status.toLowerCase()%>"><%=item.status%></span></td>
                    <td><%=item.quantity%></td>
                    <td>₹<%=item.price%></td>
                    <td>₹<%=item.price * item.quantity%></td>
                    <td>
                      <% if (item.status === 'processing') { %>
                          <button class="od-btn" onclick="event.stopPropagation(); window.location.href='/user/cancelOrder/<%=orders.orderID%>/<%=item.product%>'">Cancel Order</button>
                      <% } else if (item.status === 'shipped') { %>
                          <span class="od-btn od-btn-disabled">Cancellation not possible after shipping</span>
                      <% } else if (item.status === 'delivered') { %>
                          <button class="od-btn" onclick="event.stopPropagation(); window.location.href='/user/returnOrder/<%=orders.orderID%>/<%=item.product%>'">Return</button>
                      <% } else if (item.status === 'Payment Pending') { %>
                        <button class="od-btn" onclick="handleRepayment('<%= orders.orderID %>', '<%= item.product %>')">
                          Re-Payment
                        </button>
                      <% } else if (item.status === 'cancel request') { %>
                          <button class="od-btn od-btn-disabled" disabled>Cancel Request Pending</button>
                      <% }else if (item.status === 'canceled') { %>
                        <button class="od-btns">Cancelled</button>
                        <%} else if (item.status === 'Return Request') { %>
                          <button class="od-btn od-btn-disabled" disabled>Return Request Pending</button>
                      <% }else if (item.status === 'Returned') { %>
                        <button class="od-btns">Returned</button>
                        <%}%>
                  </td>
                  </tr>
                <% }); %>
              </tbody>
          </table>
      </div>

      <div class="od-summary-section">
          <h2 class="od-info-title">Order Summary</h2>
          <div class="od-summary-grid">
              <span class="od-label">Subtotal:</span>
              <span class="od-value">₹<%= orders.orderedItem.reduce((total, item) => total + (item.price * item.quantity), 0) %></span>
              
              <span class="od-label">Discount:</span>
              <span class="od-value">₹-<%=orders.discount%></span>
              
              <span class="od-label">Shipping:</span>
              <span class="od-value">₹<%=orders.deliveryCharge%></span>
              
              <div class="od-label od-summary-total">Total:</div>
              <div class="od-value od-summary-total">₹<%=orders.totalAmount%></div>
          </div>
      </div>
  </div>
</div>


<script>
  //logout

  function logout(event) {
  event.preventDefault(); 
  
  fetch('/user/logout', {
    method: 'POST',
    credentials: 'include'
, // Include cookies in the request
  })
    .then(response => {
      if (response.ok) {
        
        window.location.href = '/user/login';
      } else {
        Swal.fire('Logout failed!');
      }
    })
    .catch(error => {
      console.error('Error during logout:', error);
      Swal.fire('An error occurred during logout. Please try again.');
    });
}
const loadRazorpayScript = () => {
    return new Promise((resolve) => {
        if (window.Razorpay) {
            resolve(true); // ✅ Razorpay already loaded
        } else {
            const script = document.createElement('script');
            script.src = "https://checkout.razorpay.com/v1/checkout.js";
            script.onload = () => resolve(true);
            script.onerror = () => resolve(false);
            document.body.appendChild(script);
        }
    });
};
const handleRepayment = async (orderID, productID) => {
    try {
        // First fetch - creating Razorpay order
        const response = await fetch('/user/retry-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'include',  // Changed from 'same-origin' to 'include'
            body: JSON.stringify({ orderID, productID })
        });

        if (!response.ok) {  // Add status check
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Received response:', data);  // Debug log

        if (!data.success) {
            throw new Error(data.message || 'Failed to create payment order');
        }

        // Initialize Razorpay with the data
        const options = {
            key: data.razorpay.key,
            amount: data.razorpay.amount,
            currency: data.razorpay.currency,
            order_id: data.razorpay.orderID,
            name: "Your Store Name",
            description: `Payment for ${data.productName}`,
            handler: function (response) {
                verifyRepayment(orderID, productID, response);  // Removed async
            },
            modal: {
                ondismiss: function() {
                    console.log('Payment modal closed');
                    alert('Payment cancelled');
                }
            }
        };

        console.log('Initializing Razorpay with options:', options);  // Debug log
          
        const rzp1 = new Razorpay(options);
        
        rzp1.on('payment.failed', function (response) {
            console.log('Payment failed:', response);  // Debug log
            alert('Payment failed: ' + response.error.description);
        });

        rzp1.open();
    } catch (error) {
        console.error('Error in handleRepayment:', error);  // Enhanced error logging
        alert(error.message || 'Error processing payment. Please try again.');
    }
};

const verifyRepayment = async (orderID, productID, paymentResponse) => {
    try {
        const res = await fetch('/user/verify-repayment', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'include',  // Changed from 'same-origin' to 'include'
            body: JSON.stringify({ orderID, productID, paymentResponse })
        });

        if (!res.ok) {  // Add status check
            throw new Error(`HTTP error! status: ${res.status}`);
        }

        const result = await res.json();
        console.log('Verification response:', result);  // Debug log

        if (result.success) {
            alert('Payment successful!');
            window.location.reload();
        } else {
            throw new Error('Payment verification failed');
        }
    } catch (error) {
        console.error('Error in verifyRepayment:', error);  // Enhanced error logging
        alert('Error verifying payment. Please try again.');
    }
};
</script>