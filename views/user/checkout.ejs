
<div class="hero-wrap hero-bread" style="background-image: url('/images/bg_1.jpg');">
    <div class="container">
      <div class="row no-gutters slider-text align-items-center justify-content-center">
        <div class="col-md-9 ftco-animate text-center">
          <p class="breadcrumbs">
            <span class="mr-2"><a href="/user/home">Home</a></span> 
            <% if(currentPage !== 'Home') { %>
                <span><%= currentPage %></span>
            <% } %>
        </p>
          <h1 class="mb-0 bread">Checkout</h1>
        </div>
      </div>
    </div>
  </div>
  
  <section class="ftco-section">
    <div class="container">
        <!-- Delivery Address Section -->
        <div class="delivery-address-section">
            <h3 class="mb-4 delivery-heading">Delivery Address</h3>
            <form id="checkoutForm">
                <div class="saved-address-list">
                    <% addresses.forEach(function(address) { %>
                        <div class="saved-address-item">
                            <div class="address-radio-group">
                                <input 
                                    type="radio" 
                                    name="savedAddress" 
                                    value="<%= address._id %>" 
                                    id="address<%= address._id %>"
                                    required
                                >
                                <label for="address<%= address._id %>" class="address-label">
                                    <div class="address-content">
                                        <p class="saved-address-details">
                                            <%= address.firstname %> <%= address.lastname %>, 
                                            <%= address.address %>, 
                                            <%= address.postalCode %>, 
                                            <%= address.email %>
                                        </p>
                                        <p class="saved-address-phone">
                                            <%= address.mobile %>
                                        </p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    <% });%>
                </div>

                <div class="row justify-content-center">
                    <div class="col-xl-7 ftco-animate">
                        <!-- Billing Form -->
                        <div class="billing-form">
                            <h3 class="mb-4 billing-heading">Billing Details</h3>
                            <div class="row align-items-end">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="firstname">First Name</label>
                                        <input type="text" class="form-control" id="firstname" name="firstName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="lastname">Last Name</label>
                                        <input type="text" class="form-control" id="lastname" name="lastName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="email">Email Address</label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="mobile">Mobile Number</label>
                                        <input type="tel" class="form-control" id="mobile" name="mobileNumber" required>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="address">Address</label>
                                        <input type="text" class="form-control" id="address" name="address" placeholder="Your full address" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="postalCode">Postal Code</label>
                                        <input type="text" class="form-control" id="postalCode" name="postalCode" required>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-group mt-4">
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" id="sameAsDelivery" name="sameAsDelivery" class="mr-2">
                                                Same as delivery address
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cart Total and Payment Section -->
                    <div class="col-xl-5">
                        <div class="row mt-5 pt-3">
                            <div class="col-md-12 d-flex mb-5">
                                <div class="cart-detail cart-total p-3 p-md-4">
                                    <h3 class="billing-heading mb-4">Cart Total</h3>
                                    <p class="d-flex">
                                        <span>Subtotal</span>
                                        <span>₹<%= cartTotal.toFixed(2) %></span>
                                    </p>
                                    <p class="d-flex">
                                        <span>Delivery</span>
                                        <span>₹<%= deliveryCharge.toFixed(2) %></span>
                                    </p>
                                    <p class="d-flex">
                                        <span>Discount</span>
                                        <span>₹<%= discount.toFixed(2) %></span>
                                    </p>
                                    <hr>
                                    <p class="d-flex total-price">
                                        <span>Total</span>
                                        <span>₹<%= finalTotal.toFixed(2) %></span>
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="cart-detail p-3 p-md-4">
                                    <h3 class="billing-heading mb-4">Payment Method</h3>
                                    <div class="form-group">
                                        <div class="col-md-12">
                                            <div class="radio">
                                                <label>
                                                    <input type="radio" name="payment" value="wallet" class="mr-2" >
                                                    Wallet
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-12">
                                            <div class="radio">
                                                <label>
                                                    <input type="radio" name="payment" value="cod" class="mr-2" >
                                                    Cash on Delivery
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-12">
                                            <div class="radio">
                                                <label>
                                                    <input type="radio" name="payment" value="razorpay" class="mr-2" >
                                                    Razorpay
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-12">
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" id="terms" class="mr-2" >
                                                    I have read and accept the terms and conditions
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary py-3 px-4 w-100">Place Order</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<script>

document.addEventListener('DOMContentLoaded', function() {
   
    const checkoutForm = document.getElementById('checkoutForm');
    const sameAsDeliveryCheckbox = document.getElementById('sameAsDelivery');

    // Function to copy delivery address to billing
    sameAsDeliveryCheckbox.addEventListener('change', async function() {
        if (!this.checked) {
            clearBillingForm();
            return;
        }

        const selectedAddress = document.querySelector('input[name="savedAddress"]:checked');
        if (!selectedAddress) {
            Swal.fire({
                icon: 'warning',
                title: 'Select Address',
                text: 'Please select a delivery address first'
            });
            this.checked = false;
            return;
        }

        try {
            const addressDiv = selectedAddress.closest('.saved-address-item');
            const details = addressDiv.querySelector('.saved-address-details').textContent;
            const phone = addressDiv.querySelector('.saved-address-phone').textContent;

            // Split the details string and clean up each part
            const parts = details.split(',').map(part => part.trim());
            const firstLastName = parts[0].split(' ').map(part => part.trim());
            const firstName = firstLastName[0];
            const lastName = firstLastName[1];
            const streetAddress = parts[1];
            const postalCode = parts[2];
            const email = parts[3];

            // Fill the billing form
            document.getElementById('firstname').value = firstName;
            document.getElementById('lastname').value = lastName;
            document.getElementById('email').value = email;
            document.getElementById('mobile').value = phone.trim();
            document.getElementById('address').value = streetAddress;
            document.getElementById('postalCode').value = postalCode;

        } catch (error) {
            console.error('Error copying address:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to copy address details. Please fill in manually.'
            });
            this.checked = false;
            clearBillingForm();
        }
    });

    function clearBillingForm() {
        document.getElementById('firstname').value = '';
        document.getElementById('lastname').value = '';
        document.getElementById('email').value = '';
        document.getElementById('mobile').value = '';
        document.getElementById('address').value = '';
        document.getElementById('postalCode').value = '';
    }

    // Handle form submission with proper validation
    checkoutForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submission started'); // Debug log

        // Validate delivery address selection
        const selectedAddress = document.querySelector('input[name="savedAddress"]:checked');
        if (!selectedAddress) {
            Swal.fire({
                icon: 'warning',
                title: 'Select Address',
                text: 'Please select a delivery address'
            });
            return;
        }

        // Get all form values and log them
        const formValues = {
            firstname: document.getElementById('firstname').value,
            lastname: document.getElementById('lastname').value,
            email: document.getElementById('email').value,
            mobile: document.getElementById('mobile').value,
            address: document.getElementById('address').value,
            postalCode: document.getElementById('postalCode').value
        };

        console.log('Form values:', formValues); // Debug log

        // Check for empty fields
        const emptyFields = Object.entries(formValues)
            .filter(([key, value]) => !value.trim())
            .map(([key]) => key);

        if (emptyFields.length > 0) {
            console.log('Empty fields:', emptyFields); // Debug log
            Swal.fire({
                icon: 'warning',
                title: 'Missing Information',
                text: `Please fill in all required fields`
            });
            return;
        }

        // Validate payment method
        const selectedPayment = document.querySelector('input[name="payment"]:checked');
        if (!selectedPayment || selectedPayment.value !== 'cod') {
            Swal.fire({
                icon: 'warning',
                title: 'Payment Method',
                text: 'Currently only Cash on Delivery (COD) is available'
            });
            return;
        }

        // Validate terms acceptance
        if (!document.getElementById('terms').checked) {
            Swal.fire({
                icon: 'warning',
                title: 'Terms & Conditions',
                text: 'Please accept the terms and conditions'
            });
            return;
        }

        try {
            const formData = {
                addressId: selectedAddress.value,
                paymentMethod: selectedPayment.value,
                billing: {
                    firstName: formValues.firstname,
                    lastName: formValues.lastname,
                    email: formValues.email,
                    phone: formValues.mobile,
                    address: formValues.address,
                    postcode: formValues.postalCode
                }
            };

            console.log('Submitting form data:', formData); // Debug log

            const response = await fetch('/user/placeOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Order placed successfully',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = `/user/orderSuccess/${result.orderId}`;
                });
            } else {
                throw new Error(result.message || 'Failed to place order');
            }
        } catch (error) {
            console.error('Order submission error:', error); 
            Swal.fire({
                icon: 'error',
                title: 'Order Failed',
                text: error.message || 'Failed to place order. Please try again.'
            });
        }
    });
});

</script>
